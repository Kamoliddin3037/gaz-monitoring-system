<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kassa Tafsilotlari - Gaz Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-badge { font-size: 1.2rem; padding: 8px 16px; }
        .info-card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 10px; }
        .info-table th { width: 40%; font-weight: 600; color: #495057; }
        .info-table td { color: #212529; }
        .progress { height: 20px; }
        .screenshot-container { background-color: #e9ecef; padding: 20px; border-radius: 10px; text-align: center; min-height: 400px; display: flex; align-items: center; justify-content: center; }
        .screenshot-container img { max-width: 100%; border-radius: 5px; }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; }
        .nav-tabs .nav-link.active { color: #0d6efd; font-weight: 600; }
        .screenshot-thumb { cursor: pointer; transition: transform 0.2s; border: 2px solid #dee2e6; border-radius: 5px; padding: 5px; }
        .screenshot-thumb:hover { transform: scale(1.05); border-color: #0d6efd; }
        .alert-thumb { border-color: #ffc107; }
        .list-group-item-warning { background-color: #fff3cd; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="zapravkalar.html"><i class="bi bi-arrow-left"></i> Orqaga</a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3"><i class="bi bi-person-circle"></i> Admin</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Chiqish</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><span class="badge bg-success status-badge me-2">üü¢ LIVE</span><span id="kassaTitle">KASSA_005 - Sirdaryo</span></h2>
            <button class="btn btn-primary" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Yangilash</button>
        </div>

        <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#umumiy"><i class="bi bi-info-circle"></i> Umumiy</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#screenshots"><i class="bi bi-camera"></i> Screenshotlar</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#keyboard"><i class="bi bi-keyboard"></i> Keyboard</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#alerts"><i class="bi bi-exclamation-triangle"></i> Alertlar</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#remote"><i class="bi bi-controller"></i> Masofadan Boshqarish</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="umumiy">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card info-card">
                            <div class="card-header bg-white"><h5 class="mb-0">üìã Asosiy Ma'lumotlar</h5></div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless info-table">
                                    <tr><th>PC Nomi:</th><td>KASSA_005_PC</td></tr>
                                    <tr><th>IP Manzil:</th><td>192.168.1.45</td></tr>
                                    <tr><th>Viloyat:</th><td>Sirdaryo, Guliston</td></tr>
                                    <tr><th>Operator:</th><td>Jasur Karimov</td></tr>
                                    <tr><th>Holat:</th><td><span class="badge bg-success">Online</span></td></tr>
                                    <tr><th>Ish vaqti:</th><td>8 soat 34 daqiqa</td></tr>
                                    <tr><th>Internet:</th><td>‚úÖ 50 Mbps</td></tr>
                                    <tr><th>CPU:</th><td><div class="progress"><div class="progress-bar bg-primary" style="width: 12%">12%</div></div></td></tr>
                                    <tr><th>RAM:</th><td><div class="progress"><div class="progress-bar bg-warning" style="width: 52%">4.2GB / 8GB</div></div></td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8 mb-3">
                        <div class="card info-card">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">üé• Jonli Screenshot</h5>
                                <small class="text-muted">Oxirgi: 3 soniya oldin</small>
                            </div>
                            <div class="card-body">
                                <div class="screenshot-container">
                                    <img src="https://via.placeholder.com/1200x675/e9ecef/6c757d?text=Jonli+Screenshot" class="img-fluid" id="liveScreenshot">
                                </div>
                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-sm btn-primary"><i class="bi bi-play-fill"></i> Avto-yangilanish YONIQ</button>
                                    <button class="btn btn-sm btn-outline-primary"><i class="bi bi-camera"></i> Screenshot Olish</button>
                                    <button class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Yuklab Olish</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="screenshots">
                <div class="card info-card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üì∏ Screenshotlar - Bugun</h5>
                        <div><label class="me-2">Interval:</label><select class="form-select form-select-sm d-inline-block w-auto"><option>5 daqiqa</option><option>10 daqiqa</option><option>15 daqiqa</option></select></div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 col-sm-4 col-6 mb-3"><div class="screenshot-thumb"><img src="https://via.placeholder.com/300x169/e9ecef/6c757d?text=14:00" class="img-fluid"><small class="d-block text-center mt-1">14:00</small></div></div>
                            <div class="col-md-2 col-sm-4 col-6 mb-3"><div class="screenshot-thumb"><img src="https://via.placeholder.com/300x169/e9ecef/6c757d?text=14:05" class="img-fluid"><small class="d-block text-center mt-1">14:05</small></div></div>
                            <div class="col-md-2 col-sm-4 col-6 mb-3"><div class="screenshot-thumb alert-thumb"><img src="https://via.placeholder.com/300x169/fff3cd/856404?text=14:10+ALERT" class="img-fluid"><small class="d-block text-center mt-1 text-warning">14:10 ‚ö†Ô∏è</small></div></div>
                            <div class="col-md-2 col-sm-4 col-6 mb-3"><div class="screenshot-thumb"><img src="https://via.placeholder.com/300x169/e9ecef/6c757d?text=14:15" class="img-fluid"><small class="d-block text-center mt-1">14:15</small></div></div>
                            <div class="col-md-2 col-sm-4 col-6 mb-3"><div class="screenshot-thumb"><img src="https://via.placeholder.com/300x169/e9ecef/6c757d?text=14:20" class="img-fluid"><small class="d-block text-center mt-1">14:20</small></div></div>
                            <div class="col-md-2 col-sm-4 col-6 mb-3"><div class="screenshot-thumb"><img src="https://via.placeholder.com/300x169/e9ecef/6c757d?text=14:25" class="img-fluid"><small class="d-block text-center mt-1">14:25</small></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="keyboard">
                <div class="card info-card">
                    <div class="card-header bg-white"><h5 class="mb-0">‚å®Ô∏è Keyboard Faolligi - Bugun</h5></div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead><tr><th>Vaqt</th><th>Dastur</th><th>Yozilgan Matn</th><th>Holat</th></tr></thead>
                                <tbody>
                                    <tr><td>09:15:23</td><td><span class="badge bg-success">KASSA.exe</span></td><td><code>100000 [ENTER]</code></td><td><i class="bi bi-check-circle text-success"></i></td></tr>
                                    <tr><td>09:16:45</td><td><span class="badge bg-success">KASSA.exe</span></td><td><code>12.5 [ENTER]</code></td><td><i class="bi bi-check-circle text-success"></i></td></tr>
                                    <tr><td>10:30:12</td><td><span class="badge bg-primary">Chrome.exe</span></td><td><code>google.com [ENTER]</code></td><td><i class="bi bi-check-circle text-success"></i></td></tr>
                                    <tr class="table-warning"><td>14:10:22</td><td><span class="badge bg-danger">Telegram.exe</span></td><td><code>salom qanaqa [ENTER]</code></td><td><i class="bi bi-exclamation-triangle text-warning"></i></td></tr>
                                    <tr class="table-warning"><td>14:11:05</td><td><span class="badge bg-danger">Telegram.exe</span></td><td><code>yaxshi sen [ENTER]</code></td><td><i class="bi bi-exclamation-triangle text-warning"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="alerts">
                <div class="card info-card">
                    <div class="card-header bg-white"><h5 class="mb-0">üö® Bugungi Alertlar</h5></div>
                    <div class="card-body">
                        <div class="list-group">
                            <div class="list-group-item list-group-item-warning">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div><h6 class="mb-1">‚ö†Ô∏è TELEGRAM Ochildi</h6><p class="mb-1">Telegram Desktop dasturi ishga tushirildi</p><small class="text-muted">14:10:22</small></div>
                                    <div class="btn-group"><button class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> Ko'rish</button><button class="btn btn-sm btn-outline-primary"><i class="bi bi-camera"></i> Screenshot</button></div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div><h6 class="mb-1">üîå USB Ulandi</h6><p class="mb-1">Flash disk ulandi (SanDisk 32GB)</p><small class="text-muted">12:45:10</small></div>
                                    <button class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> Ko'rish</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="remote">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card info-card">
                            <div class="card-header bg-white"><h5 class="mb-0">üñ•Ô∏è Masofadan Ekran</h5></div>
                            <div class="card-body">
                                <button class="btn btn-primary btn-lg w-100 mb-3"><i class="bi bi-display"></i> Masofadan Ekranni Boshlash</button>
                            </div>
                        </div>
                        <div class="card info-card">
                            <div class="card-header bg-white"><h5 class="mb-0">üíª CMD Terminal</h5></div>
                            <div class="card-body">
                                <textarea class="form-control mb-2" rows="3" placeholder="ipconfig">ipconfig</textarea>
                                <button class="btn btn-success w-100"><i class="bi bi-play-fill"></i> Bajarish</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card info-card">
                            <div class="card-header bg-white"><h5 class="mb-0">üì∑ Veb-kamera</h5></div>
                            <div class="card-body">
                                <div class="screenshot-container" style="min-height: 300px;">
                                    <img src="https://via.placeholder.com/400x300/e9ecef/6c757d?text=Veb-kamera" class="img-fluid">
                                </div>
                                <div class="mt-3 d-grid gap-2">
                                    <button class="btn btn-primary"><i class="bi bi-camera"></i> Rasm Olish</button>
                                    <button class="btn btn-outline-primary"><i class="bi bi-camera-video"></i> Video Boshlash</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    if (!localStorage.getItem('isLoggedIn')) window.location.href = 'index.html';
    
    function logout() {
        if (confirm('Rostdan ham chiqmoqchimisiz?')) {
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'index.html';
        }
    }
    
    function refreshKassa() { location.reload(); }

    // ==========================================
    // API CONFIGURATION
    // ==========================================
    const SERVER_URL = 'http://192.168.0.108:8000';  // Mac IP
    
    const urlParams = new URLSearchParams(window.location.search);
    const kassaId = urlParams.get('id') || '007';
    document.getElementById('kassaTitle').textContent = `KASSA_${kassaId} - Sirdaryo`;

    // ==========================================
    // LOAD KASSA DATA
    // ==========================================
    async function loadKassaData() {
        try {
            const response = await fetch(`${SERVER_URL}/api/kassa/${kassaId}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            console.log('‚úÖ Kassa data:', data);
            
            // Update status badge
            const badge = document.getElementById('statusBadge');
            if (data.status === 'online') {
                badge.className = 'badge bg-success status-badge me-2';
                badge.innerHTML = 'üü¢ LIVE';
            } else {
                badge.className = 'badge bg-danger status-badge me-2';
                badge.innerHTML = 'üî¥ OFFLINE';
            }
            
            // Load LIVE screenshot (oxirgi screenshot)
            if (data.screenshots && data.screenshots.length > 0) {
                const screenshot = data.screenshots[0];  // Eng yangi
                const img = document.getElementById('liveScreenshot');
                if (img) {
                    img.src = `${SERVER_URL}${screenshot.url}?t=${Date.now()}`;
                    img.onerror = () => {
                        console.error('‚ùå Screenshot yuklanmadi');
                        img.src = 'https://via.placeholder.com/1200x675/e9ecef/6c757d?text=Screenshot+topilmadi';
                    };
                    console.log('üì∏ Live Screenshot:', screenshot.url);
                }
            } else {
                console.warn('‚ö†Ô∏è Screenshot mavjud emas');
                const img = document.getElementById('liveScreenshot');
                if (img) {
                    img.src = 'https://via.placeholder.com/1200x675/e9ecef/6c757d?text=Screenshot+hali+yuklanmagan';
                }
            }
            
        } catch (error) {
            console.error('‚ùå API xato:', error);
        }
    }

    // ==========================================
    // LOAD SCREENSHOTS GALLERY
    // ==========================================
    async function loadScreenshots() {
        try {
            const response = await fetch(`${SERVER_URL}/api/kassa/${kassaId}/screenshots?limit=24`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            console.log('‚úÖ Screenshots gallery:', data);
            
            // Find container in "Screenshotlar" tab
            const screenshotsTab = document.getElementById('screenshots');
            if (!screenshotsTab) {
                console.warn('‚ö†Ô∏è Screenshots tab topilmadi');
                return;
            }
            
            // Find .row container
            let container = screenshotsTab.querySelector('.row');
            if (!container) {
                // Create if not exists
                const card = screenshotsTab.querySelector('.card-body');
                if (card) {
                    container = document.createElement('div');
                    container.className = 'row';
                    card.appendChild(container);
                }
            }
            
            if (!container) return;
            
            container.innerHTML = ''; // Clear
            
            if (data.screenshots && data.screenshots.length > 0) {
                data.screenshots.forEach((screenshot, index) => {
                    // Parse timestamp
                    let timeStr = 'N/A';
                    try {
                        if (screenshot.created_at) {
                            const date = new Date(screenshot.created_at);
                            timeStr = date.toLocaleTimeString('uz-UZ', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        } else if (screenshot.timestamp) {
                            const date = new Date(parseFloat(screenshot.timestamp) * 1000);
                            timeStr = date.toLocaleTimeString('uz-UZ', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        }
                    } catch (e) {
                        console.error('Time parse error:', e);
                    }
                    
                    // Create thumbnail
                    const col = document.createElement('div');
                    col.className = 'col-md-2 col-sm-4 col-6 mb-3';
                    col.innerHTML = `
                        <div class="screenshot-thumb" style="cursor: pointer;" onclick="window.open('${SERVER_URL}${screenshot.url}', '_blank')">
                            <img src="${SERVER_URL}${screenshot.url}" 
                                 class="img-fluid" 
                                 loading="lazy"
                                 onerror="this.src='https://via.placeholder.com/300x169/e9ecef/6c757d?text=Error'">
                            <small class="d-block text-center mt-1">${timeStr}</small>
                        </div>
                    `;
                    container.appendChild(col);
                });
                
                console.log(`‚úÖ ${data.screenshots.length} ta screenshot yuklandi`);
                
            } else {
                container.innerHTML = '<div class="col-12"><p class="text-muted text-center">Screenshotlar topilmadi</p></div>';
            }
            
        } catch (error) {
            console.error('‚ùå Screenshots gallery xato:', error);
        }
    }

    // ==========================================
    // INITIAL LOAD
    // ==========================================
    loadKassaData();
    loadScreenshots();
    
    // ==========================================
    // AUTO-REFRESH (ixtiyoriy - faol tab da)
    // ==========================================
    let autoRefreshInterval;
    
    // Tab visibility detection
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // Tab inactive - to'xtatish
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        } else {
            // Tab active - boshlash
            if (!autoRefreshInterval) {
                autoRefreshInterval = setInterval(() => {
                    loadKassaData();
                    loadScreenshots();
                }, 30000);  // 30 sekund
            }
        }
    });
    
    // Initial auto-refresh
    autoRefreshInterval = setInterval(() => {
        loadKassaData();
        loadScreenshots();
    }, 30000);  // 30 sekund
</script>
    <script>
/* =========================
   LIVE SCREENSHOT QO‚ÄòSHIMCHA
========================= */

// üîß server IP (MAC)
const SERVER = "http://192.168.0.108:8000";

// üîÑ jonli screenshot yuklash
async function loadLiveScreenshot() {
    try {
        const res = await fetch(`${SERVER}/api/kassa/${kassaId}`);
        const data = await res.json();

        if (data.screenshots && data.screenshots.length > 0) {
            const last = data.screenshots[data.screenshots.length - 1];

            const img = document.getElementById("liveScreenshot");
            img.src = SERVER + last.url + "?t=" + Date.now(); // cache yo‚Äòq
        }
    } catch (err) {
        console.error("LIVE screenshot error:", err);
    }
}

// birinchi yuklash
loadLiveScreenshot();

// üîÅ har 5 soniyada yangilab turadi
//setInterval(loadLiveScreenshot, 5000);
</script>

</body>
</html>